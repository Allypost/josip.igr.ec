---
import type { ImageMetadata } from "astro";
import { ViewTransitions } from "astro:transitions";
import { SEO } from "astro-seo";

import { SITE_DESCRIPTION, SITE_TITLE } from "~/app/consts";
import { remoteCdnUrl } from "~/app/helpers";

export type ImageProp = {
  data?: string | ImageMetadata;
  alt?: string;
};

type Props = {
  title?: string;
  description?: string;
  image?: ImageProp;
};

const { title, description = SITE_DESCRIPTION, image: imageProp } = Astro.props;
const imageData = imageProp?.data;

const image = {
  src: undefined,
  metadata: undefined,
  alt: imageProp?.alt,
} as {
  src: string | undefined;
  metadata: ImageMetadata | undefined;
  alt: string | undefined;
};

switch (typeof imageData) {
  case "undefined":
    break;
  case "string":
    image.src = imageData;
    break;
  default:
    image.src = new URL(imageData.src).toString();
    image.metadata = imageData;
    break;
}
---

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

<link rel="icon" type="image/x-icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
<link rel="manifest" href="/site.webmanifest" />
<link
  rel="alternate"
  type="application/rss+xml"
  title={SITE_TITLE}
  href="/rss.xml"
/>

<link rel="preconnect" href={remoteCdnUrl()} crossorigin />
<link
  rel="stylesheet"
  href={remoteCdnUrl("/pkg/font/IosevkAlly/IosevkAlly.css")}
/>
<link
  rel="stylesheet"
  href={remoteCdnUrl("/pkg/font/IosevkAlly/IosevkAllyP.css")}
/>
<link
  rel="stylesheet"
  href={remoteCdnUrl("/pkg/font/IosevkAlly/IosevkAllySP.css")}
/>

<ViewTransitions />

<SEO
  title={title}
  titleDefault={SITE_TITLE}
  titleTemplate={`%s | ${SITE_TITLE}`}
  description={description}
  openGraph={title && image.src
    ? {
        basic: {
          type: "website",
          title,
          url: Astro.url,
          image: image.src,
        },
        optional: {
          description,
          locale: "en_US",
          siteName: SITE_TITLE,
        },
        image: {
          alt: image.alt,
          url: image.src,
          height: image.metadata?.height,
          width: image.metadata?.width,
          type: image.metadata?.format
            ? `image/${image.metadata.format}`
            : undefined,
        },
      }
    : undefined}
  twitter={{
    card: "summary_large_image",
    title,
    description,
    image: image.src,
  }}
/>
